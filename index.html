<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>a7lan7is n3t</title>
  <meta name="description" content="">
  <meta name="author" content="">

	<script src="js/jquery-1.7.1.min.js"></script>
	<script src="js/jquery.mousewheel-min.js"></script>
	<script src="js/jquery.terminal-0.9.0_dev.min.js"></script>
	<script src="js/qrcode.min.js"></script>
	<script src="js/splash.js"></script>
	<script src="js/help.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<!-- <link href="css/jquery.terminal-0.9.0_dev.css" rel="stylesheet"/> -->
	<link href="css/a7lan7is.css" rel="stylesheet"/>

	<script>
	
	
	var a7lan7is = {
	   groups : {},
	   nickname : "",
	   getUsers : function (gname, category, location, limit, callback) {
           var data = {};
           
           if (typeof gname != 'undefined' && gname) {
               data.group_name = gname;
           }
           
           if (typeof category != 'undefined' && category) {
               data.category = category;
           }
           
           if (typeof location != 'undefined' && location) {
               data.location = location;
           }
           if (typeof limit != 'undefined' && limit) {
               data.limit = limit;
           }
           
           $.ajax({
               url:      "/a7lan7is_n3t/getUsers.php",
               async:    false,
               dataType: "json",
               data:     data,
               success:  function(json) {
                   if (typeof callback === 'function') {
                       callback(json);
                   }
                   
               },
               error :  function() {
               }
           
           });
       },
	   loadGroups : function (name, category, location, limit, callback) {
	        var data = {};
	        
	        if (typeof name != 'undefined' && name) {
	            data.name = name;
	            data.skypeid = a7lan7is.nickname;
	        }
	        
	        if (typeof category != 'undefined' && category) {
                data.category = category;
            }
	        
	        if (typeof location != 'undefined' && location) {
                data.location = location;
            }
	        
	        if (typeof limit != 'undefined' && limit) {
               data.limit = limit;
            }
	        
	        $.ajax({
	            url:      "/a7lan7is_n3t/getGroups.php",
	            async:    false,
	            dataType: "json",
	            data:     data,
	            success:  function(json) {
	                if (json) {
		                a7lan7is.groups = json;
		            }
	                if (typeof callback === 'function') {
                        callback();
                    }
	                
	            },
	            error :  function() {
	                
	            }
	        
            });
	    },
	    createGroup: function (name, category, location, url, callback) {
	        data = {
	                name :  name,
	                category : category,
	                location : location,
	                url :  url
	        };
	        $.ajax({
                url:      "/a7lan7is_n3t/createGroup.php",
                async:    false,
                dataType: "json",
                data:     data,
                success:  function(json) {
                    if (typeof callback === 'function') {
                        callback(url);
                    }
                },
                error :  function() {
                    
                }
            
            });
	    },
	    getCategories :  function (location, callback) {
	        var data = {type: 'getCategories'};
            
            if (typeof location != 'undefined' && location) {
                data.limit = location;
            }
            
            $.ajax({
                url:      "/a7lan7is_n3t/availableData.php",
                async:    false,
                dataType: "json",
                data:     data,
                success:  function(json) {
                    if (typeof callback === 'function') {
                        callback(json);
                    }
                },
                error :  function() {
                    
                }
            
            });
	    },
	    getLocation : function(category, callback) {
	        var data = {type: 'getLocations'};
            
            if (typeof category != 'undefined' && category) {
                data.limit = category;
            }
            
            $.ajax({
                url:      "/a7lan7is_n3t/availableData.php",
                async:    false,
                dataType: "json",
                data:     data,
                success:  function(json) {
                    if (typeof callback === 'function') {
                        callback(json);
                    }
                },
                error :  function() {
                    
                }
            
            });
	    }
	}


	String.prototype.capitalize = function() {
	  return this.charAt(0).toUpperCase() + this.slice(1);
	}

    jQuery(document).ready(function($) {
      var groups = {};

      a7lan7is.nickname = localStorage.getItem("nickname");
        
    	function greetings(term) {
    		term.echo(splashPrompt);
        term.echo('type [[g;green;black]\'help\'] to see all available commands');

        if (a7lan7is.nickname) {
        	term.echo('Welcome back [[i;pink;black]' + a7lan7is.nickname + '] ');
        	term.set_prompt(a7lan7is.nickname + " > ");
        }
    	}

    	function groupsList(term, category, location, limit) {
				a7lan7is.loadGroups(null, category, location, limit, function() {
					var groups = a7lan7is.groups;
					$.each(groups, function( key, val ) {
						val.location = val.location.capitalize();
					})

					var grouped = _
					.chain(groups)
					.groupBy('location')
					.map(function(value, key) {
					    return {
					        location: key,
					        groups: value
					    }
					})
					.value();

			    $.each(grouped, function( key, val ) {
              term.echo('[[g;orange;black]' + val.location + ']');
              $.each(val.groups, function(key,val) {
              	term.echo('' + val.group_name + '[[i;dimgray;black] ('+ val.category_name +')]');
              })
            })
          })
    	}

    	function joinGroup(term, group) {
    	    group = group.toLowerCase();
    		a7lan7is.loadGroups(group, null , null, null, function() {
    		    if (typeof a7lan7is.groups[group] != 'undefined') {
    		        window.open(a7lan7is.groups[group]['group_link'], '_blank');
                } else {
                    term.echo(group + ' not found');
                }
    		})
    	}
    	
    	function getUsers(term, groupName, category, location, limit) {
            a7lan7is.getUsers(groupName, category, location, limit, function(json) {
            	if (json.length > 0) {
                $.each(json, function(key,val) {
                   term.echo('[[i;dimgray;black]' + val + ']');
                 })
            	} else if (groupName) {
            		term.echo("No one here!. Be the first to join [[g;green;black]" + groupName + "]");
            	} else if (location) {
            		term.echo("You're lost [[g;pink;black]Jose]!");
            	} else if (category) {
            		term.echo("No one here! Sorry, bro!");
            	}
            })
        }

    	function createGroup(term, name, category, location, url) {
    		a7lan7is.createGroup(name, category, location, url, function(json) {
    			if (json) {
    				term.echo('You da bo$$ of [[g;green;black]' + name + ']. 	 ');
    			} else {
    				term.echo('error creating group');
    			}
    		})
    	}

    	function listLocations(term, category) {
    		a7lan7is.getLocation(category, function(json) {
			    $.each(json, function( key, val ) {
              term.echo('[[g;orange;black]' + val + ']');
          })
        })
    	}

    	function listCategories(term, location) {
    		a7lan7is.getCategories(location, function(json) {
			    $.each(json, function( key, val ) {
              term.echo('[[g;aquamarine;black]' + val + ']');
          })
        })
    	}
    	
      $('body').terminal(function(command, term) {
			    if (command == 'help') {
			      term.echo(helpPrompt);
			    } else if (command.match('^groups')) {
			    	if (command.match('^groups ')) {
			    		var match = command.match('groups ([^ ]*) ([^ ]*)');
			    		var category = match[1];
			    		var location = match[2];
			    		groupsList(term, category, location);

			    	} else if (command.match('^groups-location ')) {
			    		var match = command.match('groups-location (.*)');
			    		groupsList(term, null, match[1]);

			    	} else if (command.match('^groups-category ')) {
			    		var match = command.match('groups-category (.*)');
			    		groupsList(term, match[1], null);

			    	} else {
			    		groupsList(term, null, null);
			    	}
			    } else if (command.match("^join")) {
			    	var group = command.match("^join (.*)");
			    	joinGroup(term, group[1]);

			    } else if (command.match("^create-group")) {
			    	if (a7lan7is.nickname.length > 0) {
				    	var match = command.match('create-group ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*)');
				    	createGroup(term, match[1], match[2], match[3], match[4]);
			    	} else {
			    		term.echo('Please enter your [[i;pink;black]skypeid] before doing that.');
			    	}

			    } else if (command.match('locations')) {
			    	var match = command.match('locations *(.*)');
			    	listLocations(term, match[1]);

			    }  else if (command.match('categories')) {
			    	var match = command.match('categories *(.*)');
			    	listCategories(term, match[1]);

			    } else if (command.match('^users')) {
			    	if (command.match('^users-location ')) {
			    		var match = command.match('users-location (.*)');
			    		getUsers(term, null, null, match[1]);

			    	} else if (command.match('^users-category ')) {
			    		var match = command.match('users-category (.*)');
			    		getUsers(term, null, match[1], null);

			    	} else if (command.match('^users-group ')) {
			    		var match = command.match('users-group (.*)');
			    		getUsers(term, match[1], null, null);

			    	} else {
			    		term.echo('[[i;pink;black]No Way!]')
			    	}

			  	} else if (command.match('^skypeid')) {
			    	var match = command.match('skypeid (.*)');
			    	var nick = match[1];

			    	a7lan7is.nickname = nick;
			    	localStorage.setItem("nickname", nick);
			    	term.echo("We go it! You're [[i;pink;black]" + nick + "]")
			    	term.set_prompt(a7lan7is.nickname + " > ");

			    } else if (command.match('^sudo')) {
			    	term.set_prompt('Password:');

			    } else if (command.match('^(ls|rm|cat|grep)')) {
			    	term.echo('[[i;pink;black]Gee!] you think so?!')

			   	} else if (command == 'share') {
			    	$("#qrcode").toggle();
			  	} else {
			      term.echo('Please hold the line, We will contact you as soon as we implement that command.');
			    }
				}, { 
					prompt: 'tty > ', 
					name: 'test',
					greetings: null,
					onInit: function(term) {
          	greetings(term);
      		},
      		onClear: function(term) {
      			greetings(term);
      		}
				});

			new QRCode(document.getElementById("qrcode"), window.location.href);
			$("#qrcode").hide();
    });
    </script>

</head>

<body>
 <div style="position: absolute; left: 50%; top: 20px;">
    <div id="qrcode" style="position: relative; left: -50%; padding: 20px; background-color:white;">
    </div>
  </div>
</body>
</html>